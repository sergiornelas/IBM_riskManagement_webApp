{% extends 'base.html' %}

{% block content %}

<section id="showcase-inner" class="py-5 text-white">
   <div class="container">
      <div class="row text-center">
         <div class="col-md-12">
            <h1 class="display-4">Exception requests</h1>
            <p class="lead">Manage your patches if you have struggles</p>
         </div>
      </div>
   </div>
</section>

<!-- Breadcrumb -->
<section id="bc" class="mt-3">
    <div class="container">
       <nav aria-label="breadcrumb">
          <ol class="breadcrumb">
             <li class="breadcrumb-item">
                <a href="{% url 'dashboard' %}">
                   <i class="fas fa-home"></i> Dashboard </a>
             </li>
             <li class="breadcrumb-item">
                <a href="{% url 'exceptionsBoard' %}">
                   <i class="fas fa-calendar-check"></i> Requests </a>
             </li>
          </ol>
       </nav>
    </div>
 </section>

<script>
   /*
   $(document).ready(function () {
      $.ajax({
         url: 'getValidationDetails', //AQUI SE EXTRAERÁN LOS DATOS
         type: 'GET', //OBTENDREMOS DATOS
         dataType: "text", //"json"  //FORMATO DE LOS DATOS
         success: function (data) {  //SI TODO SALE BIEN (DATOS EXISTENTES, CONEXIÓN CON EL SERVIDOR)
            data = JSON.parse(data);
            console.log(data)
         }
      })
   })
   */
</script>


<section id="dashboard" class="py-4">
   <div class="container">
      {% include 'partials/_alerts.html' %}
      <div class="row">
         <div class="col-md-12">
            <h2>Welcome {{ user.username }}</h2>
            {% if client_exceptions %}
            <p>Here are your exceptions status</p>
            
            <table class="table table-striped table-bordered">
               <thead class="table-info ">
                  <tr>
                     <th scope="col">Exclude id</th>
                     <th scope="col">Title</th>
                     <th scope="col">Limit date for approval</th>
                     <th scope="col">Content</th>
                     <th scope="col">Status</th>
                  </tr>
               </thead>
               <tbody>
                  {% for p in client_exceptions %}
                  <tr>
                    <td>{{ p.id }}</td>
                    <td>{{ p.title }}</td>
                    <td>{{ p.exclude_date }}</td>
                    <td>{{ p.content }}</td>
                     {% if p.state == "Pending" %}
                        <td style="font-style: italic; text-align:center">{{ p.state }}</td>
                        {#<td><button style="font-style: italic;" class="btn btn-block" data-toggle="modal" data-target="#inquiryModal2" >{{ p.state }}</button></td>#}
                     {% elif p.state == "Approved" %}
                        {#<td style="color:green;"><b>{{ p.state }}</b></td>#}
                        <td><button value={{ p.id }} class="btn btn-success btn-block validationsQuery" data-toggle="modal" data-target="#inquiryModal2" >{{ p.state }}</button></td>
                     {% elif p.state == "Rejected" %}
                        {#<td style="color:red;"><b>{{ p.state }}</b></td>#}
                        <td><button value={{ p.id }} class="btn btn-danger btn-block validationsQuery" data-toggle="modal" data-target="#inquiryModal2" >{{ p.state }}</button></td>
                     {% else %}
                        <td>{{ p.state }}</td>
                    {% endif %}
                  </tr>
                  {% endfor %}
               </tbody>
            </table>
            {% else %}
            <p>You have not patches</p>
            {% endif %}
         </div>
      </div>
   </div>
</section>

  <!-- Inquiry Modal Read comentaries-->
<div class="modal fade" id="inquiryModal2" role="dialog">
   <div class="modal-dialog">
      <div class="modal-content">
         <div class="modal-header">
            <h5 class="modal-title" id="inquiryModalLabel">Approval status</h5>
            <button type="button" class="close" data-dismiss="modal">
            <span>&times;</span>
            </button>
         </div>
         <div class="modal-body">
            <style>
               hr {border-top: 1px solid grey; margin-bottom: 1em;}
            </style>
            <div id="clean" class="queryContent" rows="7" class="form-control" ></div>
            <script type="text/javascript">
               $(document).ready(function () {
                   $(".validationsQuery").click(function () {

                     document.getElementById("clean").innerHTML = "";

                     query=this.value
                     query=parseInt(query)
                                          
                     $.ajax({
                        //async: false,
                        url: 'getValidationDetails',
                        method: 'POST',
                        dataType: "text", //"json"
                        data: {
                           query: query
                        },
                        success: function (data) {
                           data = JSON.parse(data);
                           console.log(data)
                           
                           $.each(data,function(key,index){
                              //key representa cada objeto del json (0, 1, 2...), index es el contenido de cada objeto.
                              
                              //new ajax -------------------------------
                              var name
                              var names = []

                              $.ajax({
                                 async: false,
                                 url: 'getApprovalNames',
                                 method: 'POST',
                                 dataType: "text", //"json"
                                 data: {
                                    data: index.fields.approver
                                 },
                                 
                                 success: function (approvername) {
                                    name = JSON.parse(approvername);
                                    
                                    $.each(name,function(key,index){
                                       names.push(index.fields.username);
                                    })
                                    console.log(names)
                                 }
                              });
                              //new ajax -------------------------------

                              $(".queryContent").append("<b>"+"Approver name:"+"</b>");
                              $(".queryContent").append("<p>"+names+"</p>");
                              $(".queryContent").append("<b>"+"Comment"+"</b>");
                              $(".queryContent").append("<p>"+index.fields.comment+"</p>");
                              $(".queryContent").append("<b>"+"Time of response"+"</b>");

                              var exceptionDate = index.fields.time

                              function formatDate(date) {
                                 var d = new Date(date),
                                    month = d.getMonth(),
                                    date = d.getDate(),
                                    year = d.getFullYear(),
                                    hours = ('0' + d.getHours()).slice(-2),
                                    minutes = ('0' + d.getMinutes()).slice(-2);

                                 month++;

                                 return (month + '/' + date +'/' + year + ' ' + hours + ':' + minutes);
                              }
                              $(".queryContent").append("<p>"+formatDate(exceptionDate)+"</p>");
                              $(".queryContent").append("<hr>");
                           })
                        }
                     })
                   });
               });
           </script>
            <hr>
            <input type="submit" name="state" value="Close" class="btn btn-block btn-success col-md" data-dismiss="modal">
         </div>
                        <!-- name = database field, value = input value to db -->
      </div>
   </div>
</div>

{% endblock %}